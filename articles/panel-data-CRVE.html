<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Cluster-robust standard errors and hypothesis tests in panel data models • clubSandwich</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cluster-robust standard errors and hypothesis tests in panel data models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">clubSandwich</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.11.9999</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/meta-analysis-with-CRVE.html">Meta-analysis with cluster-robust variance estimation</a></li>
    <li><a class="dropdown-item" href="../articles/panel-data-CRVE.html">Cluster-robust standard errors and hypothesis tests in panel data models</a></li>
    <li><a class="dropdown-item" href="../articles/Wald-tests-in-clubSandwich.html">Wald tests of multiple-constraint null hypotheses</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jepusto/clubSandwich/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Cluster-robust standard errors and hypothesis tests in panel data models</h1>
                        <h4 data-toc-skip class="author">James E.
Pustejovsky</h4>
            
            <h4 data-toc-skip class="date">2025-03-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jepusto/clubSandwich/blob/main/vignettes/panel-data-CRVE.Rmd" class="external-link"><code>vignettes/panel-data-CRVE.Rmd</code></a></small>
      <div class="d-none name"><code>panel-data-CRVE.Rmd</code></div>
    </div>

    
    
<p>The importance of using cluster-robust variance estimators (i.e.,
“clustered standard errors”) in panel models is now widely recognized.
Less widely recognized is the fact that standard methods for
constructing hypothesis tests and confidence intervals based on CRVE can
perform quite poorly in when based on a limited number of independent
clusters. Furthermore, it can be difficult to determine what counts as a
large-enough sample to trust standard CRVE methods, because the
finite-sample behavior of the variance estimators and test statistics
depends on the configuration of the covariates, not just the total
number of clusters.</p>
<p>One solution to this problem is to use bias-reduced linearization
(BRL), which was proposed by Bell and McCaffrey (2002) and has recently
begun to receive attention in the econometrics literature (e.g., Cameron
&amp; Miller, 2015; Imbens &amp; Kolesar, 2015). The idea of BRL is to
correct the bias of standard CRVE based on a working model, and then to
use a degrees-of-freedom correction for Wald tests based on the
bias-reduced CRVE. That may seem silly (after all, the whole point of
CRVE is to avoid making distributional assumptions about the errors in
your model), but it turns out that the correction can help quite a bit,
even when the working model is wrong. The degrees-of-freedom correction
is based on a standard Satterthwaite-type approximation, and also relies
on the working model.</p>
<p>A problem with Bell and McCaffrey’s original formulation of BRL is
that it does not work in some very common models for panel data, such as
state-by-year panels that include fixed effects for each state and each
year (Angrist and Pischke, 2009, point out this issue in their chapter
on “non-standard standard error issues”; see also Young, 2016). However,
Pustejovsky and Tipton (2016) proposed a generalization of BRL that
works even in models with arbitrary sets of fixed effects, and this
generalization is implemented in <code>clubSandwich</code> as CRVE type
<code>CR2</code>. The package also implements small-sample corrections
for multiple-constraint hypothesis tests based on an approximation
proposed by Pustejovsky and Tipton (2016). For one-parameter
constraints, the test reduces to a t-test with Satterthwaite degrees of
freedom, and so it is a natural extension of BRL.</p>
<p>The following example demonstrates how to use
<code>clubSandwich</code> to do cluster-robust inference for a
state-by-year panel model with fixed effects in both dimensions,
clustering by states.</p>
<div class="section level2">
<h2 id="effects-of-changing-the-minimum-legal-drinking-age">Effects of changing the minimum legal drinking age<a class="anchor" aria-label="anchor" href="#effects-of-changing-the-minimum-legal-drinking-age"></a>
</h2>
<p>Carpenter and Dobkin (2011) analyzed the effects of changes in the
minimum legal drinking age on rates of motor vehicle fatalities among
18-20 year olds, using state-level panel data from the National Highway
Traffic Administration’s Fatal Accident Reporting System. In their new
textbook, Angrist and Pischke (2014) developed a stylized example based
on Carpenter and Dobkin’s work. The following example uses Angrist and
Pischke’s data and follows their analysis because their data are <a href="https://www.masteringmetrics.com/resources/" class="external-link">easily
available</a>.</p>
<p>The outcome is the incidence of deaths in motor vehicle crashes among
18-20 year-olds (per 100,000 residents), for each state plus the
District of Columbia, over the period 1970 to 1983. There were several
changes in the minimum legal drinking age during this time period, with
variability in the timing of changes across states. Angrist and Pischke
(following Carpenter and Dobkin) use a difference-in-differences
strategy to estimate the effects of lowering the minimum legal drinking
age from 21 to 18. Their specification is</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>=</mo><msub><mi>α</mi><mi>i</mi></msub><mo>+</mo><msub><mi>β</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msub><mi>b</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>+</mo><mi>δ</mi><msub><mi>d</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>+</mo><msub><mi>ϵ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>,</mo></mrow><annotation encoding="application/x-tex">y_{it} = \alpha_i + \beta_t + \gamma b_{it} + \delta d_{it} + \epsilon_{it},</annotation></semantics></math></p>
<p>for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
= 1,…,51 and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
= 1970,…,1983. In this model,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\alpha_i</annotation></semantics></math>
is a state-specific fixed effect,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\beta_t</annotation></semantics></math>
is a year-specific fixed effect,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">b_{it}</annotation></semantics></math>
is the current rate of beer taxation in state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
in year
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">d_{it}</annotation></semantics></math>
is the proportion of 18-20 year-olds in state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
in year
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
who are legally allowed to drink, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>δ</mi><annotation encoding="application/x-tex">\delta</annotation></semantics></math>
captures the effect of shifting the minimum legal drinking age from 21
to 18. Following Angrist and Pischke’s analysis, we estimate this model
both by (unweighted) OLS and by weighted least squares with weights
corresponding to population size in a given state and year. We also
demonstrate random effects estimation and implement a cluster-robust
Hausman specification test.</p>
</div>
<div class="section level2">
<h2 id="unweighted-ols">Unweighted OLS<a class="anchor" aria-label="anchor" href="#unweighted-ols"></a>
</h2>
<p>The following code does some simple data-munging and the estimates
the model by OLS:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://jepusto.github.io/clubSandwich/">clubSandwich</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">MortalityRates</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># subset for deaths in motor vehicle accidents, 1970-1983</span></span>
<span><span class="va">MV_deaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">MortalityRates</span>, <span class="va">cause</span><span class="op">==</span><span class="st">"Motor Vehicle"</span> <span class="op">&amp;</span> </span>
<span>                      <span class="va">year</span> <span class="op">&lt;=</span> <span class="fl">1983</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">beertaxa</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit by OLS</span></span>
<span><span class="va">lm_unweighted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mrate</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">legal</span> <span class="op">+</span> <span class="va">beertaxa</span> <span class="op">+</span> </span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">MV_deaths</span><span class="op">)</span></span></code></pre></div>
<p>The <code>coef_test</code> function from <code>clubSandwich</code>
can then be used to test the hypothesis that changing the minimum legal
drinking age has no effect on motor vehicle deaths in this cohort (i.e.,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub><mo>:</mo><mi>δ</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">H_0: \delta = 0</annotation></semantics></math>).
The usual way to test this is to cluster the standard errors by state,
calculate the robust Wald statistic, and compare that to a standard
normal reference distribution. The code and results are as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">lm_unweighted</span>, vcov <span class="op">=</span> <span class="st">"CR1"</span>, </span>
<span>          cluster <span class="op">=</span> <span class="va">MV_deaths</span><span class="op">$</span><span class="va">state</span>, test <span class="op">=</span> <span class="st">"naive-t"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##     Coef. Estimate   SE Null value t-stat d.f. (naive-t) p-val (naive-t) Sig.</span></span>
<span><span class="co">##     legal     7.59 2.44          0  3.108             49         0.00313   **</span></span>
<span><span class="co">##  beertaxa     3.82 5.14          0  0.743             49         0.46128</span></span></code></pre>
<p>A better approach would be to use the generalized, bias-reduced
linearization CRVE, together with Satterthwaite degrees of freedom. In
the <code>clubSandwich</code> package, the BRL adjustment is called
“CR2” because it is directly analogous to the HC2 correction used in
heteroskedasticity-robust variance estimation. When applied to an OLS
model estimated by <code>lm</code>, the default working model is an
identity matrix, which amounts to the “working” assumption that the
errors are all uncorrelated and homoskedastic. Here’s how to apply this
approach in the example:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">lm_unweighted</span>, vcov <span class="op">=</span> <span class="st">"CR2"</span>, </span>
<span>          cluster <span class="op">=</span> <span class="va">MV_deaths</span><span class="op">$</span><span class="va">state</span>, test <span class="op">=</span> <span class="st">"Satterthwaite"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##     Coef. Estimate   SE Null value t-stat d.f. (Satt) p-val (Satt) Sig.</span></span>
<span><span class="co">##     legal     7.59 2.51          0  3.019       24.58      0.00583   **</span></span>
<span><span class="co">##  beertaxa     3.82 5.27          0  0.725        5.77      0.49663</span></span></code></pre>
<p>The Satterthwaite degrees of freedom are different for each
coefficient in the model, and so the <code>coef_test</code> function
reports them right alongside the standard error. For the effect of legal
drinking age, the degrees of freedom are about half of what might be
expected, given that there are 51 clusters. The p-value for the
CR2+Satterthwaite test is about twice as large as the p-value based on
the standard Wald test, although the coefficient is still statistically
significant at conventional levels. Note, however, that the degrees of
freedom on the beer taxation rate are considerably smaller because there
are only a few states with substantial variability in taxation rates
over time.</p>
</div>
<div class="section level2">
<h2 id="unweighted-within-estimation">Unweighted “within” estimation<a class="anchor" aria-label="anchor" href="#unweighted-within-estimation"></a>
</h2>
<p>The <code>plm</code> package in R provides another way to estimate
the same model. It is convenient because it absorbs the state and year
fixed effects before estimating the effect of <code>legal</code>. The
<code>clubSandwich</code> package works with fitted <code>plm</code>
models too:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org/package=plm" class="external-link">plm</a></span><span class="op">)</span></span>
<span><span class="va">plm_unweighted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plm/man/plm.html" class="external-link">plm</a></span><span class="op">(</span><span class="va">mrate</span> <span class="op">~</span> <span class="va">legal</span> <span class="op">+</span> <span class="va">beertaxa</span>, data <span class="op">=</span> <span class="va">MV_deaths</span>, </span>
<span>                      effect <span class="op">=</span> <span class="st">"twoways"</span>, index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"state"</span>,<span class="st">"year"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">plm_unweighted</span>, vcov <span class="op">=</span> <span class="st">"CR1"</span>, cluster <span class="op">=</span> <span class="st">"individual"</span>, test <span class="op">=</span> <span class="st">"naive-t"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##     Coef. Estimate   SE Null value t-stat d.f. (naive-t) p-val (naive-t) Sig.</span></span>
<span><span class="co">##     legal     7.59 2.44          0  3.108             49         0.00313   **</span></span>
<span><span class="co">##  beertaxa     3.82 5.14          0  0.743             49         0.46128</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">plm_unweighted</span>, vcov <span class="op">=</span> <span class="st">"CR2"</span>, cluster <span class="op">=</span> <span class="st">"individual"</span>, test <span class="op">=</span> <span class="st">"Satterthwaite"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##     Coef. Estimate   SE Null value t-stat d.f. (Satt) p-val (Satt) Sig.</span></span>
<span><span class="co">##     legal     7.59 2.51          0  3.019       24.58      0.00583   **</span></span>
<span><span class="co">##  beertaxa     3.82 5.27          0  0.725        5.77      0.49663</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="population-weighted-estimation">Population-weighted estimation<a class="anchor" aria-label="anchor" href="#population-weighted-estimation"></a>
</h2>
<p>The difference between the standard method and the new method are not
terribly exciting in the above example. However, things change quite a
bit if the model is estimated using population weights. We go back to
fitting in <code>lm</code> with dummies for all the fixed effects
because <code>plm</code> does not handle weighted least squares.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lm_weighted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mrate</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">legal</span> <span class="op">+</span> <span class="va">beertaxa</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, </span>
<span>                  weights <span class="op">=</span> <span class="va">pop</span>, data <span class="op">=</span> <span class="va">MV_deaths</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">lm_weighted</span>, vcov <span class="op">=</span> <span class="st">"CR1"</span>, </span>
<span>          cluster <span class="op">=</span> <span class="va">MV_deaths</span><span class="op">$</span><span class="va">state</span>, test <span class="op">=</span> <span class="st">"naive-t"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##     Coef. Estimate   SE Null value t-stat d.f. (naive-t) p-val (naive-t) Sig.</span></span>
<span><span class="co">##     legal     7.78 2.01          0   3.87             49          &lt;0.001  ***</span></span>
<span><span class="co">##  beertaxa    11.16 4.20          0   2.66             49          0.0106    *</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">lm_weighted</span>, vcov <span class="op">=</span> <span class="st">"CR2"</span>, </span>
<span>          cluster <span class="op">=</span> <span class="va">MV_deaths</span><span class="op">$</span><span class="va">state</span>, test <span class="op">=</span> <span class="st">"Satterthwaite"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##     Coef. Estimate   SE Null value t-stat d.f. (Satt) p-val (Satt) Sig.</span></span>
<span><span class="co">##     legal     7.78 2.13          0   3.64        8.52      0.00588   **</span></span>
<span><span class="co">##  beertaxa    11.16 4.37          0   2.55        6.85      0.03854    *</span></span></code></pre>
<p>Using population weights slightly reduces the point estimate of the
effect, while also slightly increasing its precision. If you were
following the standard approach, you would probably be happy with the
weighted estimates and wouldn’t think about it any further. However,
using the CR2 variance estimator and Satterthwaite correction produces a
p-value that is an order of magnitude larger (though still significant
at the conventional 5% level). The degrees of freedom are just
8.5—drastically smaller than would be expected based on the number of
clusters.</p>
<p>Even with weights, the <code>coef_test</code> function uses an
“independent, homoskedastic” working model as a default for
<code>lm</code> objects. In the present example, the outcome is a
standardized rate and so a better assumption might be that the error
variances are inversely proportional to population size. The following
code uses this alternate working model:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">lm_weighted</span>, vcov <span class="op">=</span> <span class="st">"CR2"</span>, </span>
<span>          cluster <span class="op">=</span> <span class="va">MV_deaths</span><span class="op">$</span><span class="va">state</span>, target <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">MV_deaths</span><span class="op">$</span><span class="va">pop</span>, </span>
<span>          test <span class="op">=</span> <span class="st">"Satterthwaite"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##     Coef. Estimate   SE Null value t-stat d.f. (Satt) p-val (Satt) Sig.</span></span>
<span><span class="co">##     legal     7.78 2.03          0   3.83       12.64      0.00221   **</span></span>
<span><span class="co">##  beertaxa    11.16 4.17          0   2.68        5.06      0.04333    *</span></span></code></pre>
<p>The new working model leads to slightly smaller standard errors and a
couple of additional degrees of freedom, though they remain in
small-sample territory.</p>
</div>
<div class="section level2">
<h2 id="random-effects-estimation">Random effects estimation<a class="anchor" aria-label="anchor" href="#random-effects-estimation"></a>
</h2>
<p>If the unobserved effects
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>1</mn></msub><mo>,</mo><mi>.</mi><mi>.</mi><mi>.</mi><mo>,</mo><msub><mi>α</mi><mn>51</mn></msub></mrow><annotation encoding="application/x-tex">\alpha_1,...,\alpha_{51}</annotation></semantics></math>
are uncorrelated with the regressors, then a more efficient way to
estimate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mo>,</mo><mi>δ</mi></mrow><annotation encoding="application/x-tex">\gamma,\delta</annotation></semantics></math>
is by weighted least squares, with weights based on a random effects
model. We still treat the year effects as fixed.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plm_random</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plm/man/plm.html" class="external-link">plm</a></span><span class="op">(</span><span class="va">mrate</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">legal</span> <span class="op">+</span> <span class="va">beertaxa</span> <span class="op">+</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">MV_deaths</span>, </span>
<span>                  effect <span class="op">=</span> <span class="st">"individual"</span>, index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"state"</span>,<span class="st">"year"</span><span class="op">)</span>,</span>
<span>                  model <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">plm_random</span>, vcov <span class="op">=</span> <span class="st">"CR1"</span>, test <span class="op">=</span> <span class="st">"naive-t"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##     Coef. Estimate   SE Null value t-stat d.f. (naive-t) p-val (naive-t) Sig.</span></span>
<span><span class="co">##     legal     7.31 2.39          0  3.054             49         0.00364   **</span></span>
<span><span class="co">##  beertaxa     3.37 5.11          0  0.661             49         0.51202</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">plm_random</span>, vcov <span class="op">=</span> <span class="st">"CR2"</span>, test <span class="op">=</span> <span class="st">"Satterthwaite"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##     Coef. Estimate   SE Null value t-stat d.f. (Satt) p-val (Satt) Sig.</span></span>
<span><span class="co">##     legal     7.31 2.46          0  2.966       25.18      0.00652   **</span></span>
<span><span class="co">##  beertaxa     3.37 5.22          0  0.647        5.78      0.54258</span></span></code></pre>
<p>With random effects estimation, the effect of legal drinking age is
smaller by about 1 death per 100,000. As a procedural aside, note that
<code>coef_test</code> infers that <code>state</code> is the clustering
variable because the call to plm includes only one type of effects
(random state effects).</p>
</div>
<div class="section level2">
<h2 id="robust-hausman-test">Robust Hausman test<a class="anchor" aria-label="anchor" href="#robust-hausman-test"></a>
</h2>
<p>CRVE is also used in specification tests, as in the artificial
Hausman-type test for endogeneity of unobserved effects (Arellano,
1993). As noted above, random effects estimation is more efficient than
fixed effects estimation, but requires the assumption that the
unobserved effects are uncorrelated with the regressors. However, if the
unobserved effects covary with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>𝐛</mi><mi>i</mi></msub><mo>,</mo><msub><mi>𝐝</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{b}_i, \mathbf{d}_i</annotation></semantics></math>,
then the random-effects estimator will be biased.</p>
<p>We can test for whether endogeneity is a problem by including
group-centered covariates as additional regressors. Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>d</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>=</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>−</mo><mfrac><mn>1</mn><mi>T</mi></mfrac><msub><mo>∑</mo><mi>t</mi></msub><msub><mi>d</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\tilde{d}_{it} = d_{it} - \frac{1}{T}\sum_t d_{it}</annotation></semantics></math>,
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>b</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">\tilde{b}_{it}</annotation></semantics></math>
defined analogously. Now estimate the regression</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>=</mo><msub><mi>β</mi><mi>t</mi></msub><mo>+</mo><msub><mi>γ</mi><mn>1</mn></msub><msub><mi>b</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>+</mo><msub><mi>γ</mi><mn>2</mn></msub><msub><mover><mi>b</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>+</mo><msub><mi>δ</mi><mn>1</mn></msub><msub><mi>d</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>+</mo><msub><mi>δ</mi><mn>2</mn></msub><msub><mover><mi>d</mi><mo accent="true">̃</mo></mover><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>+</mo><msub><mi>ϵ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>,</mo></mrow><annotation encoding="application/x-tex">y_{it} = \beta_t + \gamma_1 b_{it} + \gamma_2 \tilde{b}_{it} + \delta_1 d_{it} + \delta_2 \tilde{d}_{it} + \epsilon_{it},</annotation></semantics></math></p>
<p>which does not include state fixed effects. The parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>γ</mi><mn>2</mn></msub><mo>,</mo><msub><mi>δ</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\gamma_2,\delta_2</annotation></semantics></math>
represent the differences between the within-groups and between-groups
estimands of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>γ</mi><mn>1</mn></msub><mo>,</mo><msub><mi>δ</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\gamma_1, \delta_1</annotation></semantics></math>.
If these are both zero, then the random effects estimator is unbiased.
Thus, the joint test for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub><mo>:</mo><msub><mi>γ</mi><mn>2</mn></msub><mo>=</mo><msub><mi>δ</mi><mn>2</mn></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">H_0: \gamma_2 = \delta_2 = 0</annotation></semantics></math>
amounts to a test for exogeneity of the unobserved effects.</p>
<p>For efficiency, we estimate this specification using weighted least
squares (although OLS would be valid too):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MV_deaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="va">MV_deaths</span>, <span class="op">{</span></span>
<span>  <span class="va">legal_cent</span> <span class="op">&lt;-</span> <span class="va">legal</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">legal</span>, <span class="va">state</span>, <span class="va">mean</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">beer_cent</span> <span class="op">&lt;-</span> <span class="va">beertaxa</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">beertaxa</span>, <span class="va">state</span>, <span class="va">mean</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plm_Hausman</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plm/man/plm.html" class="external-link">plm</a></span><span class="op">(</span><span class="va">mrate</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">legal</span> <span class="op">+</span> <span class="va">beertaxa</span> <span class="op">+</span> <span class="va">legal_cent</span> <span class="op">+</span> <span class="va">beer_cent</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, </span>
<span>                   data <span class="op">=</span> <span class="va">MV_deaths</span>,</span>
<span>                   effect <span class="op">=</span> <span class="st">"individual"</span>, index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"state"</span>,<span class="st">"year"</span><span class="op">)</span>,</span>
<span>                   model <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/coef_test.html">coef_test</a></span><span class="op">(</span><span class="va">plm_Hausman</span>, vcov <span class="op">=</span> <span class="st">"CR2"</span>, test <span class="op">=</span> <span class="st">"Satterthwaite"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Alternative hypothesis: two-sided </span></span>
<span><span class="co">##       Coef. Estimate   SE Null value  t-stat d.f. (Satt) p-val (Satt) Sig.</span></span>
<span><span class="co">##       legal   -9.180 7.62          0 -1.2042       24.94       0.2398     </span></span>
<span><span class="co">##    beertaxa    3.395 9.40          0  0.3613        6.44       0.7295     </span></span>
<span><span class="co">##  legal_cent   16.768 8.53          0  1.9665       25.44       0.0602    .</span></span>
<span><span class="co">##   beer_cent    0.424 9.25          0  0.0458        6.42       0.9648</span></span></code></pre>
<p>To conduct a joint test on the centered covariates, we can use the
<code>Wald_test</code> function. The usual way to test this hypothesis
would be to use the <code>CR1</code> variance estimator to calculate the
robust Wald statistic, then use a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>χ</mi><mn>2</mn><mn>2</mn></msubsup><annotation encoding="application/x-tex">\chi^2_2</annotation></semantics></math>
reference distribution (or equivalently, compare a re-scaled Wald
statistic to an
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>,</mo><mi>∞</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">F(2,\infty)</annotation></semantics></math>
distribution). The <code>Wald_test</code> function reports the latter
version:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Wald_test.html">Wald_test</a></span><span class="op">(</span><span class="va">plm_Hausman</span>, </span>
<span>          constraints <span class="op">=</span> <span class="fu"><a href="../reference/constraint_matrices.html">constrain_zero</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"legal_cent"</span>,<span class="st">"beer_cent"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          vcov <span class="op">=</span> <span class="st">"CR1"</span>, test <span class="op">=</span> <span class="st">"chi-sq"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    test Fstat df_num df_denom  p_val sig</span></span>
<span><span class="co">##  chi-sq  2.93      2      Inf 0.0534   .</span></span></code></pre>
<p>The test is just shy of significance at the 5% level. If we instead
use the <code>CR2</code> variance estimator and our newly proposed
approximate F-test (which is the default in <code>Wald_test</code>),
then we get:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Wald_test.html">Wald_test</a></span><span class="op">(</span><span class="va">plm_Hausman</span>, </span>
<span>          constraints <span class="op">=</span> <span class="fu"><a href="../reference/constraint_matrices.html">constrain_zero</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"legal_cent"</span>,<span class="st">"beer_cent"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          vcov <span class="op">=</span> <span class="st">"CR2"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  test Fstat df_num df_denom p_val sig</span></span>
<span><span class="co">##   HTZ  2.56      2     11.7  0.12</span></span></code></pre>
<p>The low degrees of freedom of the test indicate that we’re definitely
in small-sample territory and should not trust the asymptotic
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>χ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\chi^2</annotation></semantics></math>
approximation.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Angrist, J. D., &amp; Pischke, J. (2009). <em>Mostly harmless
econometrics: An empiricist’s companion</em>. Princeton, NJ: Princeton
University Press.</p>
<p>Angrist, J. D., and Pischke, J. S. (2014). <em>Mastering’metrics: the
path from cause to effect</em>. Princeton, NJ: Princeton University
Press.</p>
<p>Arellano, M. (1993). On the testing of correlated effects with panel
data. Journal of Econometrics, 59(1-2), 87-97. doi: <a href="https://www.sciencedirect.com/science/article/pii/030440769390040C" class="external-link">10.1016/0304-4076(93)90040-C</a></p>
<p>Bell, R. M., &amp; McCaffrey, D. F. (2002). Bias reduction in
standard errors for linear regression with multi-stage samples.
<em>Survey Methodology, 28</em>(2), 169-181.</p>
<p>Cameron, A. C., &amp; Miller, D. L. (2015). A practitioner’s guide to
cluster-robust inference. URL: <a href="https://cameron.econ.ucdavis.edu/research/Cameron_Miller_JHR_2015_February.pdf" class="external-link uri">https://cameron.econ.ucdavis.edu/research/Cameron_Miller_JHR_2015_February.pdf</a></p>
<p>Carpenter, C., &amp; Dobkin, C. (2011). The minimum legal drinking
age and public health. <em>Journal of Economic Perspectives, 25</em>(2),
133-156. doi: <a href="https://doi.org/10.1257/jep.25.2.133" class="external-link">10.1257/jep.25.2.133</a></p>
<p>Imbens, G. W., &amp; Kolesar, M. (2015). Robust standard errors in
small samples: Some practical advice. URL: <a href="https://doi.org/10.1162/REST_a_00552" class="external-link uri">https://doi.org/10.1162/REST_a_00552</a></p>
<p>Pustejovsky, J. E. &amp; Tipton, E. (2016). Small sample methods for
cluster-robust variance estimation and hypothesis testing in fixed
effects models. arXiv: <a href="https://arxiv.org/abs/1601.01981" class="external-link">1601.01981</a> [stat.ME]</p>
<p>Young, A. (2016). Improved, nearly exact, statistical inference with
robust and clustered covariance matrices using effective degrees of
freedom corrections.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Pustejovsky.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
