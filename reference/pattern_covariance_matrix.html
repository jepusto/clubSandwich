<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Impute a patterned block-diagonal covariance matrix — pattern_covariance_matrix • clubSandwich</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Impute a patterned block-diagonal covariance matrix — pattern_covariance_matrix" />
<meta property="og:description" content="pattern_covariance_matrix calculates a
  block-diagonal covariance matrix, given the marginal variances, the block
  structure, and an assumed correlation structure defined by a patterned
  correlation matrix." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">clubSandwich</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.3.9999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/Robust-Variance-Estimation-with-clubSandwich.html">Cluster-Robust Variance Estimation with clubSandwich</a>
    </li>
    <li>
      <a href="../articles/Wald-tests-in-clubSandwich.html">Wald tests of multiple-constraint null hypotheses</a>
    </li>
    <li>
      <a href="../articles/meta-analysis-with-CRVE.html">Meta-analysis with cluster-robust variance estimation</a>
    </li>
    <li>
      <a href="../articles/panel-data-CRVE.html">Cluster-robust standard errors and hypothesis tests in panel data models</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/jepusto/clubSandwich/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Impute a patterned block-diagonal covariance matrix</h1>
    <small class="dont-index">Source: <a href='https://github.com/jepusto/clubSandwich/blob/master/R/rma-mv.R'><code>R/rma-mv.R</code></a></small>
    <div class="hidden name"><code>pattern_covariance_matrix.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><code>pattern_covariance_matrix</code> calculates a
  block-diagonal covariance matrix, given the marginal variances, the block
  structure, and an assumed correlation structure defined by a patterned
  correlation matrix.</p>
    </div>

    <pre class="usage"><span class='fu'>pattern_covariance_matrix</span><span class='op'>(</span>
  <span class='va'>vi</span>,
  <span class='va'>cluster</span>,
  <span class='va'>pattern_level</span>,
  <span class='va'>r_pattern</span>,
  <span class='va'>r</span>,
  smooth_vi <span class='op'>=</span> <span class='cn'>FALSE</span>,
  subgroup <span class='op'>=</span> <span class='cn'>NULL</span>,
  return_list <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>cluster</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>cluster</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,
  check_PD <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>vi</th>
      <td><p>Vector of variances</p></td>
    </tr>
    <tr>
      <th>cluster</th>
      <td><p>Vector indicating which effects belong to the same cluster.
Effects with the same value of `cluster` will be treated as correlated.</p></td>
    </tr>
    <tr>
      <th>pattern_level</th>
      <td><p>Vector of categories for each effect size, used to
determine which entry of the pattern matrix will be used to impute a
correlation.</p></td>
    </tr>
    <tr>
      <th>r_pattern</th>
      <td><p>Patterned correlation matrix with row and column names
corresponding to the levels of <code>pattern</code>.</p></td>
    </tr>
    <tr>
      <th>r</th>
      <td><p>Vector or numeric value of assumed constant correlation(s) between
effect size estimates from each study.</p></td>
    </tr>
    <tr>
      <th>smooth_vi</th>
      <td><p>Logical indicating whether to smooth the marginal variances
by taking the average <code>vi</code> within each cluster. Defaults to
<code>FALSE</code>.</p></td>
    </tr>
    <tr>
      <th>subgroup</th>
      <td><p>Vector of category labels describing sub-groups of effects.
If non-null, effects that share the same category label and the same
cluster will be treated as correlated, but effects with different category
labels will be treated as uncorrelated, even if they come from the same
cluster.</p></td>
    </tr>
    <tr>
      <th>return_list</th>
      <td><p>Optional logical indicating whether to return a list of
matrices (with one entry per block) or the full variance-covariance matrix.</p></td>
    </tr>
    <tr>
      <th>check_PD</th>
      <td><p>Optional logical indicating whether to check whether each
covariance matrix is positive definite. If <code>TRUE</code> (the default), the
function will display a warning if any covariance matrix is not positive
definite.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>If <code>cluster</code> is appropriately sorted, then a list of matrices,
  with one entry per cluster, will be returned by default. If <code>cluster</code>
  is out of order, then the full variance-covariance matrix will be returned
  by default. The output structure can be controlled with the optional
  <code>return_list</code> argument.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>A block-diagonal variance-covariance matrix (possibly represented as
  a list of matrices) with a specified correlation structure, defined by a
  patterned correlation matrix. Let \(v_{ij}\) denote the specified
  variance for effect \(i\) in cluster \(j\) and
  \(C_{hij}\) be the covariance between effects \(h\) and
  \(i\) in cluster \(j\). Let \(p_{ij}\) be the level
  of the pattern variable for effect \(i\) in cluster \(j\),
  taking a value in \(1,...,C\). A patterned correlation matrix
  is defined as a set of correlations between pairs of effects taking each
  possible combination of patterns. Formally, let \(r_{cd}\) be the
  correlation between effects in categories \(c\) and \(d\),
  respectively, where \(r_{cd} = r_{dc}\). Then the
  covariance between effects \(h\) and \(i\) in cluster
  \(j\) is taken to be $$C_{hij} = \sqrt{v_{hj} v_{ij}} \times
  r_{p_{hj} p_{ij}}.$$</p>  
<p>Correlations between effect sizes within the same category are defined by the diagonal
  values of the pattern matrix, which may take values less than one.</p>  
<p>Combinations of pattern levels that do not occur in the patterned correlation matrix will be set equal to <code>r</code>.</p>  
<p>If <code>smooth_vi = TRUE</code>, then all of the variances within cluster
  \(j\) will be set equal to the average variance of cluster
  \(j\), i.e., $$v'_{ij} = \frac{1}{n_j} \sum_{i=1}^{n_j}
  v_{ij}$$ for
  \(i=1,...,n_j\) and \(j=1,...,k\).</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://www.metafor-project.org'>metafor</a></span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='va'>oswald2013</span>, package <span class='op'>=</span> <span class='st'>"robumeta"</span><span class='op'>)</span>
<span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://wviechtb.github.io/metafor/reference/escalc.html'>escalc</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>oswald2013</span>, measure <span class='op'>=</span> <span class='st'>"ZCOR"</span>, ri <span class='op'>=</span> <span class='va'>R</span>, ni <span class='op'>=</span> <span class='va'>N</span><span class='op'>)</span>

<span class='co'># make a patterned correlation matrix </span>

<span class='va'>p_levels</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>dat</span><span class='op'>$</span><span class='va'>Crit.Cat</span><span class='op'>)</span>
<span class='va'>r_pattern</span> <span class='op'>&lt;-</span> <span class='fl'>0.7</span><span class='op'>^</span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>as.matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/dist.html'>dist</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>p_levels</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='va'>r_pattern</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>0.75</span>, <span class='fl'>0.95</span>, length.out <span class='op'>=</span> <span class='fl'>6</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>r_pattern</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>r_pattern</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>p_levels</span>

<span class='co'># impute the covariance matrix using patterned correlations</span>
<span class='va'>V_list</span> <span class='op'>&lt;-</span> <span class='fu'>pattern_covariance_matrix</span><span class='op'>(</span>vi <span class='op'>=</span> <span class='va'>dat</span><span class='op'>$</span><span class='va'>vi</span>, 
                                    cluster <span class='op'>=</span> <span class='va'>dat</span><span class='op'>$</span><span class='va'>Study</span>, 
                                    pattern_level <span class='op'>=</span> <span class='va'>dat</span><span class='op'>$</span><span class='va'>Crit.Cat</span>,
                                    r_pattern <span class='op'>=</span> <span class='va'>r_pattern</span>,
                                    smooth_vi <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
                                    
<span class='co'># fit a model using imputed covariance matrix</span>

<span class='va'>MVFE</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://wviechtb.github.io/metafor/reference/rma.mv.html'>rma.mv</a></span><span class='op'>(</span><span class='va'>yi</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='va'>Crit.Cat</span>, V <span class='op'>=</span> <span class='va'>V_list</span>, 
               random <span class='op'>=</span> <span class='op'>~</span> <span class='va'>Crit.Cat</span> <span class='op'>|</span> <span class='va'>Study</span>,
               data <span class='op'>=</span> <span class='va'>dat</span><span class='op'>)</span>
               
<span class='fu'><a href='conf_int.html'>conf_int</a></span><span class='op'>(</span><span class='va'>MVFE</span>, vcov <span class='op'>=</span> <span class='st'>"CR2"</span><span class='op'>)</span>
</div><div class='output co'>#&gt;                             Coef Estimate     SE  d.f. Lower 95% CI
#&gt; 1         Crit.CatBrain Activity   0.1826 0.3323  4.55      -0.6979
#&gt; 2 Crit.CatInterpersonal Behavior   0.1469 0.0456  3.97       0.0199
#&gt; 3          Crit.CatMicrobehavior   0.0852 0.0320  8.56       0.0122
#&gt; 4      Crit.CatPerson Perception   0.1364 0.0249 16.77       0.0839
#&gt; 5      Crit.CatPolicy Preference   0.1334 0.0252  4.64       0.0669
#&gt; 6          Crit.CatResponse Time   0.1835 0.1410  1.76      -0.5118
#&gt;   Upper 95% CI
#&gt; 1        1.063
#&gt; 2        0.274
#&gt; 3        0.158
#&gt; 4        0.189
#&gt; 5        0.200
#&gt; 6        0.879</div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by James Pustejovsky.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


