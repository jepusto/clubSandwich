<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Impute a block-diagonal covariance matrix — impute_covariance_matrix • clubSandwich</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Impute a block-diagonal covariance matrix — impute_covariance_matrix"><meta name="description" content='`r lifecycle::badge("superseded")`
This function is superseded by the vcalc provided by
  the metafor package. Compared to impute_covariance_matrix,
  vcalc provides many further features, includes a
  data argument, and uses syntax that is consistent with other
  functions in metafor.
impute_covariance_matrix calculates a block-diagonal covariance
  matrix, given the marginal variances, the block structure, and an assumed
  correlation structure. Can be used to create compound-symmetric structures,
  AR(1) auto-correlated structures, or combinations thereof.'><meta property="og:description" content='`r lifecycle::badge("superseded")`
This function is superseded by the vcalc provided by
  the metafor package. Compared to impute_covariance_matrix,
  vcalc provides many further features, includes a
  data argument, and uses syntax that is consistent with other
  functions in metafor.
impute_covariance_matrix calculates a block-diagonal covariance
  matrix, given the marginal variances, the block structure, and an assumed
  correlation structure. Can be used to create compound-symmetric structures,
  AR(1) auto-correlated structures, or combinations thereof.'></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">clubSandwich</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/meta-analysis-with-CRVE.html">Meta-analysis with cluster-robust variance estimation</a></li>
    <li><a class="dropdown-item" href="../articles/panel-data-CRVE.html">Cluster-robust standard errors and hypothesis tests in panel data models</a></li>
    <li><a class="dropdown-item" href="../articles/Wald-tests-in-clubSandwich.html">Wald tests of multiple-constraint null hypotheses</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jepusto/clubSandwich/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Impute a block-diagonal covariance matrix</h1>
      <small class="dont-index">Source: <a href="https://github.com/jepusto/clubSandwich/blob/main/R/rma-mv.R" class="external-link"><code>R/rma-mv.R</code></a></small>
      <div class="d-none name"><code>impute_covariance_matrix.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>`r lifecycle::badge("superseded")`</p>
<p>This function is superseded by the <code><a href="https://wviechtb.github.io/metafor/reference/vcalc.html" class="external-link">vcalc</a></code> provided by
  the <code>metafor</code> package. Compared to <code>impute_covariance_matrix</code>,
  <code><a href="https://wviechtb.github.io/metafor/reference/vcalc.html" class="external-link">vcalc</a></code> provides many further features, includes a
  <code>data</code> argument, and uses syntax that is consistent with other
  functions in <code>metafor</code>.</p>
<p><code>impute_covariance_matrix</code> calculates a block-diagonal covariance
  matrix, given the marginal variances, the block structure, and an assumed
  correlation structure. Can be used to create compound-symmetric structures,
  AR(1) auto-correlated structures, or combinations thereof.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">impute_covariance_matrix</span><span class="op">(</span></span>
<span>  <span class="va">vi</span>,</span>
<span>  <span class="va">cluster</span>,</span>
<span>  <span class="va">r</span>,</span>
<span>  <span class="va">ti</span>,</span>
<span>  <span class="va">ar1</span>,</span>
<span>  smooth_vi <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  subgroup <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  return_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  check_PD <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-vi">vi<a class="anchor" aria-label="anchor" href="#arg-vi"></a></dt>
<dd><p>Vector of variances</p></dd>


<dt id="arg-cluster">cluster<a class="anchor" aria-label="anchor" href="#arg-cluster"></a></dt>
<dd><p>Vector indicating which effects belong to the same cluster.
Effects with the same value of `cluster` will be treated as correlated.</p></dd>


<dt id="arg-r">r<a class="anchor" aria-label="anchor" href="#arg-r"></a></dt>
<dd><p>Vector or numeric value of assumed constant correlation(s) between
effect size estimates from each study.</p></dd>


<dt id="arg-ti">ti<a class="anchor" aria-label="anchor" href="#arg-ti"></a></dt>
<dd><p>Vector of time-points describing temporal spacing of effects, for
use with auto-regressive correlation structures.</p></dd>


<dt id="arg-ar-">ar1<a class="anchor" aria-label="anchor" href="#arg-ar-"></a></dt>
<dd><p>Vector or numeric value of assumed AR(1) auto-correlation(s)
between effect size estimates from each study. If specified, then <code>ti</code>
argument must be specified.</p></dd>


<dt id="arg-smooth-vi">smooth_vi<a class="anchor" aria-label="anchor" href="#arg-smooth-vi"></a></dt>
<dd><p>Logical indicating whether to smooth the marginal variances
by taking the average <code>vi</code> within each cluster. Defaults to
<code>FALSE</code>.</p></dd>


<dt id="arg-subgroup">subgroup<a class="anchor" aria-label="anchor" href="#arg-subgroup"></a></dt>
<dd><p>Vector of category labels describing sub-groups of effects.
If non-null, effects that share the same category label and the same
cluster will be treated as correlated, but effects with different category
labels will be treated as uncorrelated, even if they come from the same
cluster.</p></dd>


<dt id="arg-return-list">return_list<a class="anchor" aria-label="anchor" href="#arg-return-list"></a></dt>
<dd><p>Optional logical indicating whether to return a list of
matrices (with one entry per block) or the full variance-covariance matrix.</p></dd>


<dt id="arg-check-pd">check_PD<a class="anchor" aria-label="anchor" href="#arg-check-pd"></a></dt>
<dd><p>Optional logical indicating whether to check whether each
covariance matrix is positive definite. If <code>TRUE</code> (the default), the
function will display a warning if any covariance matrix is not positive
definite.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>If <code>cluster</code> is appropriately sorted, then a list of matrices,
  with one entry per cluster, will be returned by default. If <code>cluster</code>
  is out of order, then the full variance-covariance matrix will be returned
  by default. The output structure can be controlled with the optional
  <code>return_list</code> argument.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>A block-diagonal variance-covariance matrix (possibly represented as
  a list of matrices) with a specified structure. The structure depends on
  whether the <code>r</code> argument, <code>ar1</code> argument, or both arguments are
  specified. Let \(v_{ij}\) denote the specified variance for effect
  \(i\) in cluster \(j\) and \(C_{hij}\) be the covariance
  between effects \(h\) and \(i\) in cluster
  \(j\).</p><ul><li><p>If only <code>r</code> is specified, each block of the variance-covariance
  matrix will have a constant (compound symmetric) correlation, so that
  $$C_{hij} = r_j \sqrt{v_{hj} v_{ij},}$$
  where \(r_j\) is the specified correlation
  for cluster \(j\). If only a single value is given in <code>r</code>, then
  it will be used for every cluster.</p></li>
<li><p>If only <code>ar1</code> is specified, each block of the variance-covariance matrix will have an
  AR(1) auto-correlation structure, so that
  $$C_{hij} = \phi_j^{|t_{hj}- t_{ij}|} \sqrt{v_{hj} v_{ij},}$$
  where \(\phi_j\) is the specified auto-correlation
  for cluster \(j\) and \(t_{hj}\) and \(t_{ij}\)
  are specified time-points corresponding to effects \(h\) and
  \(i\) in cluster \(j\). If only a single value is given in
  <code>ar1</code>, then it will be used for every cluster.</p></li>
<li><p>If both <code>r</code> and <code>ar1</code> are specified, each block of the variance-covariance matrix will have combination of compound symmetric and an AR(1)
  auto-correlation structures, so that
  $$C_{hij} = \left[r_j + (1 - r_j)\phi_j^{|t_{hj} - t_{ij}|}\right] \sqrt{v_{hj} v_{ij},}$$
  where \(r_j\) is the specified constant correlation for cluster
  \(j\), \(\phi_j\) is the specified auto-correlation for
  cluster \(j\) and \(t_{hj}\) and \(t_{ij}\) are
  specified time-points corresponding to effects \(h\) and
  \(i\) in cluster \(j\). If only single values are given in
  <code>r</code> or <code>ar1</code>, they will be used for every cluster.</p></li>
</ul><p>If <code>smooth_vi = TRUE</code>, then all of the variances within cluster
  \(j\) will be set equal to the average variance of cluster
  \(j\), i.e., $$v'_{ij} = \frac{1}{n_j} \sum_{i=1}^{n_j}
  v_{ij}$$ for
  \(i=1,...,n_j\) and \(j=1,...,k\).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"metafor"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.metafor-project.org" class="external-link">metafor</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Constant correlation</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">SATcoaching</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">V_list</span> <span class="op">&lt;-</span> <span class="fu">impute_covariance_matrix</span><span class="op">(</span>vi <span class="op">=</span> <span class="va">SATcoaching</span><span class="op">$</span><span class="va">V</span>, cluster <span class="op">=</span> <span class="va">SATcoaching</span><span class="op">$</span><span class="va">study</span>, r <span class="op">=</span> <span class="fl">0.66</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">MVFE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://wviechtb.github.io/metafor/reference/rma.mv.html" class="external-link">rma.mv</a></span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">test</span>, V <span class="op">=</span> <span class="va">V_list</span>, data <span class="op">=</span> <span class="va">SATcoaching</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="conf_int.html">conf_int</a></span><span class="op">(</span><span class="va">MVFE</span>, vcov <span class="op">=</span> <span class="st">"CR2"</span>, cluster <span class="op">=</span> <span class="va">SATcoaching</span><span class="op">$</span><span class="va">study</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>`impute_covariance_matrix()` was deprecated in clubSandwich 0.5.11.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Please use `metafor::vcalc()` instead.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       Coef. Estimate     SE d.f. Lower 95% CI Upper 95% CI</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    testMath    0.132 0.0376 13.2       0.0506        0.213</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  testVerbal    0.122 0.0250 16.9       0.0686        0.174</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.jepusto.com/" class="external-link">James E. Pustejovsky</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

